<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAK Edz≈ëi nyilv√°ntart√°s</title>
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#0e1630;
      --card:#101a3a;
      --card2:#0f1a3f;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:#22305a;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% 10%, #1b2a6b33, transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, #7c3aed22, transparent 60%),
                  radial-gradient(900px 600px at 60% 90%, #22c55e1d, transparent 60%),
                  linear-gradient(180deg, var(--bg), #070a16);
      color: var(--text);
    }
    a{color:inherit}
    .wrap{
      max-width: 1400px;
      margin: 22px auto 40px;
      padding: 0 16px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 16px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, #7c3aed, #22c55e);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-20px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(15deg);
    }
    .title{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .title .sub{
      color: var(--muted);
      font-size: 12px;
    }
    .topRight{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
    }
    .pill b{font-weight:700}
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 650;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.85));
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 16px 34px rgba(124,58,237,.22);
    }
    .btn.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 16px;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.25px;
      color: #f3f4f6;
    }
    .cardHeader .muted{color: var(--muted); font-size:12px}
    .cardBody{padding: 12px 14px 14px}
    .banner{
      margin: 0 0 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      color: #fde68a;
      display:none;
      gap: 10px;
      align-items:flex-start;
    }
    .banner.show{display:flex}
    .banner .dot{
      width:10px;height:10px;border-radius:50%;
      margin-top:4px;
      background: var(--warn);
      box-shadow: 0 0 0 6px rgba(245,158,11,.15);
      flex: 0 0 auto;
    }
    .tableWrap{
      overflow:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 900px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      border-right: 1px solid rgba(255,255,255,.06);
      vertical-align:top;
      position:relative;
    }
    th:last-child, td:last-child{border-right:none}
    tr:last-child td{border-bottom:none}
    thead th{
      position:sticky; top:0;
      background: rgba(12,18,40,.92);
      backdrop-filter: blur(10px);
      z-index:2;
      font-size: 12px;
      color:#cbd5e1;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    tbody th.time{
      position:sticky; left:0;
      background: rgba(12,18,40,.92);
      backdrop-filter: blur(10px);
      z-index:1;
      width: 120px;
      font-size: 12px;
      color:#cbd5e1;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .cell{
      min-height: 64px;
      border-radius: 14px;
      padding: 8px 8px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .cell:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12)}
    .cell:active{transform: translateY(1px)}
    .cell.readonly{cursor:default}
    .cell.readonly:hover{background: rgba(255,255,255,.03); border-color: rgba(255,255,255,.06)}
    .kids{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .tag{
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(124,58,237,.16);
      border: 1px solid rgba(124,58,237,.30);
      color: #e9d5ff;
      font-size: 12px;
      line-height: 1;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tag.alt{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.26);
      color: #d1fae5;
    }
    .tag.empty{
      background: rgba(148,163,184,.08);
      border-color: rgba(148,163,184,.20);
      color: #cbd5e1;
      font-style: italic;
    }
    .conflict .cell{
      border-color: rgba(239,68,68,.55) !important;
      background: rgba(239,68,68,.08) !important;
      box-shadow: 0 0 0 4px rgba(239,68,68,.08) inset;
    }
    .confBadge{
      display:none;
      position:absolute;
      right: 10px;
      top: 10px;
      font-size: 11px;
      padding: 4px 7px;
      border-radius: 999px;
      background: rgba(239,68,68,.14);
      border: 1px solid rgba(239,68,68,.35);
      color: #fecaca;
    }
    td.conflict .confBadge{display:inline-flex}
    .sideRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
    }
    .sideRow:last-child{border-bottom:none}
    .stat{
      display:flex; flex-direction:column; gap:3px;
    }
    .stat .k{color: var(--muted); font-size:12px}
    .stat .v{font-weight:800; font-size:16px}
    .mini{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .hr{
      height:1px; background: rgba(255,255,255,.08);
      margin: 10px 0;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin: 10px 0;
    }
    .field label{
      font-size:12px;
      color: var(--muted);
    }
    input[type="text"], textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
    }
    textarea{min-height: 160px; resize: vertical; line-height:1.4}
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width: min(720px, 100%);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .modalHead h3{margin:0; font-size: 14px}
    .modalHead .meta{color: var(--muted); font-size:12px; margin-top:4px}
    .modalBody{padding: 14px 16px}
    .modalFoot{
      padding: 14px 16px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      flex-wrap:wrap;
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      color: #e5e7eb;
      font-weight: 650;
      display:none;
      z-index: 60;
    }
    .toast.show{display:block}
    .kbd{
      font-size: 11px;
      color: #cbd5e1;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 6px;
    }
    .fileInput{display:none}
    .summaryTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .summaryTable th, .summaryTable td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      border-right: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      vertical-align: top;
    }
    .summaryTable th{
      background: rgba(12,18,40,.75);
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size: 11px;
      color:#cbd5e1;
    }
    .summaryTable tr:last-child td{border-bottom:none}
    .summaryTable td:last-child, .summaryTable th:last-child{border-right:none}
    .chips{
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .chip{
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(148,163,184,.10);
      border: 1px solid rgba(148,163,184,.22);
      color: #e5e7eb;
      max-width: 100%;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>DAK Edz≈ëi nyilv√°ntart√°s</h1>
          <div class="sub">Edz≈ëk fixek ¬∑ Gyerekek v√°ltoznak ¬∑ Heti t√°bl√°zat + √∂sszes√≠t≈ë</div>
        </div>
      </div>

      <div class="topRight">
        <div class="pill" title="Aktu√°lis h√©t (h√©tf≈ëi kezd√©ssel)">
          <span>üìÖ</span>
          <div><b id="weekLabel">‚Äî</b> <span class="muted" id="weekRange"></span></div>
        </div>

        <button class="btn small" id="prevWeekBtn" title="El≈ëz≈ë h√©t"><span>‚¨ÖÔ∏è</span> El≈ëz≈ë</button>
        <button class="btn small" id="nextWeekBtn" title="K√∂vetkez≈ë h√©t">K√∂vetkez≈ë <span>‚û°Ô∏è</span></button>

        <button class="btn primary" id="summaryBtn" title="2-es funkci√≥: heti √∂sszes√≠t≈ë"><span>üìä</span> Heti √∂sszes√≠t≈ë</button>

        <button class="btn" id="shareBtn" title="Read-only megoszt√°s linkkel"><span>üîó</span> Megoszt√°s</button>
        <button class="btn" id="exportBtn" title="Export JSON"><span>‚¨áÔ∏è</span> Export</button>
        <button class="btn" id="importBtn" title="Import JSON"><span>‚¨ÜÔ∏è</span> Import</button>
        <input class="fileInput" id="fileInput" type="file" accept="application/json" />
        <button class="btn danger" id="clearWeekBtn" title="Csak ezt a hetet t√∂rli a ment√©sb≈ël"><span>üóëÔ∏è</span> H√©t t√∂rl√©se</button>
      </div>
    </header>

    <div class="banner" id="readonlyBanner">
      <div class="dot" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800; margin-bottom:3px;">Read-only megosztott n√©zet</div>
        <div class="mini">Ebben a n√©zetben nem tudsz szerkeszteni. Ha saj√°t ment√©st akarsz: nyisd meg a linket hash n√©lk√ºl, vagy k√©sz√≠ts exportot √©s import√°ld.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Heti beoszt√°s</h2>
            <div class="muted">Kattints egy cell√°ra szerkeszt√©shez. √útk√∂z√©s (azonos gyerek ugyanabban az id≈ës√°vban t√∂bb edz≈ën√©l) pirossal jel√∂lve.</div>
          </div>
          <div class="row">
            <button class="btn small" id="todayBtn" title="Ugr√°s a jelenlegi h√©tre"><span>üß≠</span> Aktu√°lis h√©t</button>
            <button class="btn small" id="copyWeekKeyBtn" title="Ment√©si kulcs m√°sol√°sa (debug/ellen≈ërz√©s)"><span>üß©</span> Kulcs</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="tableWrap">
            <table id="scheduleTable" aria-label="Heti beoszt√°s t√°bl√°zat">
              <!-- JS t√∂lti -->
            </table>
          </div>
          <div class="hint" style="margin-top:10px;">
            Tipp: a gyerekeket √≠rd vessz≈ëvel vagy √∫j sorban. Ment√©s automatikus (localStorage).
            <span class="kbd">Esc</span> bez√°rja a modalt.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>√Ållapot & gyors inf√≥k</h2>
            <div class="muted">√ñsszefoglal√≥ az aktu√°lis h√©tr≈ël</div>
          </div>
        </div>
        <div class="cardBody" id="sidePanel">
          <!-- JS t√∂lti -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modalOverlay" id="editOverlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="editTitle">Szerkeszt√©s</h3>
          <div class="meta" id="editMeta">‚Äî</div>
        </div>
        <button class="btn small" id="closeEditBtn" title="Bez√°r√°s (Esc)"><span>‚úñÔ∏è</span> Bez√°r</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label for="kidsInput">Gyerekek (vessz≈ëvel vagy √∫j sorban)</label>
          <textarea id="kidsInput" placeholder="pl.: Martin, √Åd√°m&#10;Bence"></textarea>
          <div class="hint" id="conflictHint" style="display:none;color:#fecaca;">
            ‚ö†Ô∏è √útk√∂z√©s: a list√°ban szerepl≈ë gyerek(ek) ugyanebben az id≈ës√°vban m√°shol is szerepelnek.
          </div>
        </div>
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="hint">Ment√©s ut√°n a heti √∂sszes√≠t≈ë automatikusan friss√ºl.</div>
          <button class="btn danger small" id="clearCellBtn" title="Cellatartalom t√∂rl√©se"><span>üßΩ</span> Cellat√∂rl√©s</button>
        </div>
      </div>
      <div class="modalFoot">
        <div class="row">
          <button class="btn" id="cancelEditBtn"><span>‚Ü©Ô∏è</span> M√©gse</button>
        </div>
        <div class="row">
          <button class="btn primary" id="saveEditBtn"><span>üíæ</span> Ment√©s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Modal -->
  <div class="modalOverlay" id="summaryOverlay" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <div class="modal" style="width:min(980px, 100%);">
      <div class="modalHead">
        <div>
          <h3 id="summaryTitle">Heti √∂sszes√≠t≈ë</h3>
          <div class="meta" id="summaryMeta">‚Äî</div>
        </div>
        <button class="btn small" id="closeSummaryBtn" title="Bez√°r√°s (Esc)"><span>‚úñÔ∏è</span> Bez√°r</button>
      </div>
      <div class="modalBody" id="summaryBody">
        <!-- JS t√∂lti -->
      </div>
      <div class="modalFoot">
        <div class="row">
          <button class="btn" id="copySummaryBtn" title="√ñsszes√≠t≈ë m√°sol√°sa v√°g√≥lapra"><span>üìã</span> M√°sol√°s</button>
        </div>
        <div class="row">
          <button class="btn primary" id="closeSummaryBtn2"><span>‚úÖ</span> K√©sz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modalOverlay" id="shareOverlay" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="shareTitle">Megoszt√°s (read-only link)</h3>
          <div class="meta">Ezt elk√ºldheted b√°rkinek: meg tudja n√©zni, de nem tudja szerkeszteni.</div>
        </div>
        <button class="btn small" id="closeShareBtn" title="Bez√°r√°s (Esc)"><span>‚úñÔ∏è</span> Bez√°r</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label for="shareLink">Link</label>
          <input id="shareLink" type="text" readonly />
          <div class="hint">A link a jelenlegi h√©t adatait tartalmazza a URL hash-ben.</div>
        </div>
        <div class="row">
          <button class="btn primary" id="copyShareBtn"><span>üìã</span> Link m√°sol√°sa</button>
          <button class="btn" id="openShareBtn"><span>üëÅÔ∏è</span> Megnyit√°s</button>
        </div>
      </div>
      <div class="modalFoot">
        <div class="row">
          <button class="btn" id="closeShareBtn2"><span>‚úÖ</span> K√©sz</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Mentve</div>

  <script>
    /***********************
     *  CONFIG (fix edz≈ëk / id≈ës√°vok / napok)
     ***********************/
    const COACHES = [
      { id: "edzo1", name: "Edz≈ë 1" },
      { id: "edzo2", name: "Edz≈ë 2" },
      { id: "edzo3", name: "Edz≈ë 3" },
      { id: "edzo4", name: "Edz≈ë 4" }
    ];

    const DAYS = [
      { id: "mon", label: "H√©tf≈ë" },
      { id: "tue", label: "Kedd" },
      { id: "wed", label: "Szerda" },
      { id: "thu", label: "Cs√ºt√∂rt√∂k" },
      { id: "fri", label: "P√©ntek" },
      { id: "sat", label: "Szombat" },
      { id: "sun", label: "Vas√°rnap" }
    ];

    // Ha n√°latok csak h√©tk√∂znap kell, itt egyszer≈±en t√∂r√∂ld a sat/sun-t.
    const TIME_SLOTS = [
      "08:00‚Äì09:00",
      "09:00‚Äì10:00",
      "10:00‚Äì11:00",
      "11:00‚Äì12:00",
      "12:00‚Äì13:00",
      "13:00‚Äì14:00",
      "14:00‚Äì15:00",
      "15:00‚Äì16:00",
      "16:00‚Äì17:00",
      "17:00‚Äì18:00",
      "18:00‚Äì19:00",
      "19:00‚Äì20:00"
    ];

    /***********************
     *  STATE
     ***********************/
    const els = {
      scheduleTable: document.getElementById("scheduleTable"),
      weekLabel: document.getElementById("weekLabel"),
      weekRange: document.getElementById("weekRange"),
      prevWeekBtn: document.getElementById("prevWeekBtn"),
      nextWeekBtn: document.getElementById("nextWeekBtn"),
      todayBtn: document.getElementById("todayBtn"),
      clearWeekBtn: document.getElementById("clearWeekBtn"),
      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      fileInput: document.getElementById("fileInput"),
      shareBtn: document.getElementById("shareBtn"),
      copyWeekKeyBtn: document.getElementById("copyWeekKeyBtn"),

      sidePanel: document.getElementById("sidePanel"),

      editOverlay: document.getElementById("editOverlay"),
      editTitle: document.getElementById("editTitle"),
      editMeta: document.getElementById("editMeta"),
      kidsInput: document.getElementById("kidsInput"),
      conflictHint: document.getElementById("conflictHint"),
      closeEditBtn: document.getElementById("closeEditBtn"),
      cancelEditBtn: document.getElementById("cancelEditBtn"),
      saveEditBtn: document.getElementById("saveEditBtn"),
      clearCellBtn: document.getElementById("clearCellBtn"),

      summaryBtn: document.getElementById("summaryBtn"),
      summaryOverlay: document.getElementById("summaryOverlay"),
      closeSummaryBtn: document.getElementById("closeSummaryBtn"),
      closeSummaryBtn2: document.getElementById("closeSummaryBtn2"),
      summaryMeta: document.getElementById("summaryMeta"),
      summaryBody: document.getElementById("summaryBody"),
      copySummaryBtn: document.getElementById("copySummaryBtn"),

      shareOverlay: document.getElementById("shareOverlay"),
      closeShareBtn: document.getElementById("closeShareBtn"),
      closeShareBtn2: document.getElementById("closeShareBtn2"),
      shareLink: document.getElementById("shareLink"),
      copyShareBtn: document.getElementById("copyShareBtn"),
      openShareBtn: document.getElementById("openShareBtn"),

      toast: document.getElementById("toast"),
      readonlyBanner: document.getElementById("readonlyBanner"),
    };

    let readOnly = false;

    // currentWeekStart: Date (h√©tf≈ë 00:00)
    let currentWeekStart = getMonday(new Date());

    // data model:
    // data[dayId][slotIndex][coachId] = array of kids (strings)
    // we'll store as { weekStartISO, data }
    let weekData = createEmptyWeekData();

    // editing context
    let editCtx = null; // { dayId, slotIndex, coachId }

    /***********************
     *  UTIL
     ***********************/
    function pad2(n){ return String(n).padStart(2,"0"); }

    function toISODate(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    }

    function formatHU(d){
      // YYYY.MM.DD
      const x = new Date(d);
      return `${x.getFullYear()}.${pad2(x.getMonth()+1)}.${pad2(x.getDate())}`;
    }

    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function getMonday(date){
      const d = new Date(date);
      d.setHours(0,0,0,0);
      const day = d.getDay(); // 0=Sun..6=Sat
      const diff = (day === 0 ? -6 : 1 - day); // back to Monday
      d.setDate(d.getDate() + diff);
      return d;
    }

    function getWeekKey(weekStartISO){
      return `dak_schedule_${weekStartISO}`;
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>els.toast.classList.remove("show"), 1600);
    }

    function normalizeKidsText(text){
      // split by comma or newline, trim, remove empties, dedupe keeping order
      const raw = text
        .split(/\n|,/g)
        .map(s => s.trim())
        .filter(Boolean);

      const seen = new Set();
      const out = [];
      for (const k of raw){
        const key = k.toLowerCase();
        if (!seen.has(key)){
          seen.add(key);
          out.push(k);
        }
      }
      return out;
    }

    function createEmptyWeekData(){
      const data = {};
      for (const day of DAYS){
        data[day.id] = [];
        for (let i=0;i<TIME_SLOTS.length;i++){
          const row = {};
          for (const c of COACHES){
            row[c.id] = [];
          }
          data[day.id].push(row);
        }
      }
      return { weekStartISO: toISODate(currentWeekStart), data };
    }

    function safeJsonParse(str){
      try { return JSON.parse(str); } catch { return null; }
    }

    function b64encodeUnicode(obj){
      const json = JSON.stringify(obj);
      const utf8 = new TextEncoder().encode(json);
      let bin = "";
      utf8.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    }

    function b64decodeUnicode(b64){
      const bin = atob(b64);
      const bytes = new Uint8Array([...bin].map(ch => ch.charCodeAt(0)));
      const json = new TextDecoder().decode(bytes);
      return JSON.parse(json);
    }

    function setReadOnlyMode(on){
      readOnly = !!on;
      els.readonlyBanner.classList.toggle("show", readOnly);

      // disable top actions that modify local data
      els.clearWeekBtn.disabled = readOnly;
      els.importBtn.disabled = readOnly;
      // export/share ok in readonly
    }

    /***********************
     *  LOAD FROM URL HASH (read-only share)
     ***********************/
    function tryLoadSharedView(){
      const hash = location.hash || "";
      const m = hash.match(/#view=([^&]+)/);
      if (!m) return false;

      try{
        const payload = b64decodeUnicode(m[1]);
        // payload: { weekStartISO, data }
        if (!payload || !payload.weekStartISO || !payload.data) return false;

        currentWeekStart = getMonday(new Date(payload.weekStartISO));
        weekData = payload;

        setReadOnlyMode(true);
        return true;
      }catch(e){
        console.warn("Share decode failed", e);
        return false;
      }
    }

    /***********************
     *  LOCAL STORAGE
     ***********************/
    function loadWeekFromStorage(){
      const weekISO = toISODate(currentWeekStart);
      const key = getWeekKey(weekISO);
      const raw = localStorage.getItem(key);
      const parsed = safeJsonParse(raw);

      if (parsed && parsed.weekStartISO === weekISO && parsed.data){
        weekData = parsed;
      } else {
        weekData = createEmptyWeekData();
        weekData.weekStartISO = weekISO;
      }
    }

    function saveWeekToStorage(){
      if (readOnly) return;
      const weekISO = toISODate(currentWeekStart);
      weekData.weekStartISO = weekISO;
      const key = getWeekKey(weekISO);
      localStorage.setItem(key, JSON.stringify(weekData));
    }

    function clearWeekStorage(){
      if (readOnly) return;
      const weekISO = toISODate(currentWeekStart);
      localStorage.removeItem(getWeekKey(weekISO));
      loadWeekFromStorage();
      renderAll();
      toast("H√©t t√∂r√∂lve");
    }

    /***********************
     *  RENDER TABLE
     ***********************/
    function renderTable(){
      // Table structure:
      // THEAD: first row empty corner + for each coach: coach name
      // TBODY: for each day: day separator row, then each time slot row with time in sticky TH,
      // and coach cells.
      const weekISO = toISODate(currentWeekStart);
      const weekEnd = addDays(currentWeekStart, 6);

      els.weekLabel.textContent = `H√©t kezdete: ${formatHU(currentWeekStart)}`;
      els.weekRange.textContent = `(${formatHU(currentWeekStart)} ‚Äì ${formatHU(weekEnd)})`;

      const t = [];
      t.push("<thead><tr>");
      t.push(`<th style="min-width:140px">Id≈ës√°v / nap</th>`);
      for (const c of COACHES){
        t.push(`<th style="min-width:220px">${escapeHtml(c.name)}</th>`);
      }
      t.push("</tr></thead>");

      t.push("<tbody>");
      for (let dIdx=0; dIdx<DAYS.length; dIdx++){
        const day = DAYS[dIdx];
        const date = addDays(currentWeekStart, dIdx);
        const dayLabel = `${day.label} ¬∑ ${formatHU(date)}`;

        // Day header row
        t.push(`<tr><th class="time" colspan="${COACHES.length+1}" style="position:sticky;left:0;z-index:3;background:rgba(12,18,40,.95);text-transform:none;letter-spacing:0;font-size:13px;color:#f3f4f6;">${escapeHtml(dayLabel)}</th></tr>`);

        for (let s=0; s<TIME_SLOTS.length; s++){
          t.push("<tr>");
          t.push(`<th class="time">${escapeHtml(TIME_SLOTS[s])}</th>`);
          for (const c of COACHES){
            const kids = (weekData.data?.[day.id]?.[s]?.[c.id]) || [];
            const preview = renderKidsTags(kids);

            const cellId = `cell_${day.id}_${s}_${c.id}`;
            t.push(`
              <td data-day="${day.id}" data-slot="${s}" data-coach="${c.id}">
                <span class="confBadge" title="√útk√∂z√©s">√útk√∂z√©s</span>
                <div class="cell ${readOnly ? "readonly":""}" id="${cellId}" title="${readOnly ? "Read-only" : "Katt: szerkeszt√©s"}">
                  ${preview}
                </div>
              </td>
            `);
          }
          t.push("</tr>");
        }
      }
      t.push("</tbody>");

      els.scheduleTable.innerHTML = t.join("");

      // click handlers
      els.scheduleTable.querySelectorAll("td[data-day]").forEach(td=>{
        td.addEventListener("click", ()=>{
          if (readOnly) return;
          const dayId = td.getAttribute("data-day");
          const slotIndex = parseInt(td.getAttribute("data-slot"), 10);
          const coachId = td.getAttribute("data-coach");
          openEdit(dayId, slotIndex, coachId);
        });
      });
    }

    function renderKidsTags(kids){
      if (!kids || kids.length === 0){
        return `<div class="kids"><span class="tag empty">‚Äî √ºres ‚Äî</span></div>`;
      }
      const out = [];
      out.push(`<div class="kids">`);
      kids.forEach((k, idx)=>{
        const alt = (idx % 2 === 1) ? "alt" : "";
        out.push(`<span class="tag ${alt}">${escapeHtml(k)}</span>`);
      });
      out.push(`</div>`);
      return out.join("");
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     *  CONFLICT DETECTION (√ºtk√∂z√©sjelz√©s)
     *  Same day+slot: same kid appears in multiple coach cells
     ***********************/
    function computeConflicts(){
      // returns Set of td elements (or keys) that are in conflict + map kid -> occurrences
      const conflicts = new Set();
      const details = {}; // key: day|slot => { kidLower: [coachId...] }

      for (const day of DAYS){
        for (let s=0; s<TIME_SLOTS.length; s++){
          const occ = new Map(); // kidLower -> coaches array
          for (const c of COACHES){
            const kids = (weekData.data?.[day.id]?.[s]?.[c.id]) || [];
            for (const kid of kids){
              const k = kid.trim().toLowerCase();
              if (!k) continue;
              if (!occ.has(k)) occ.set(k, []);
              occ.get(k).push({ coachId: c.id, kid });
            }
          }
          // mark conflicts
          for (const [kidLower, arr] of occ.entries()){
            if (arr.length > 1){
              const slotKey = `${day.id}|${s}`;
              if (!details[slotKey]) details[slotKey] = {};
              details[slotKey][kidLower] = arr.map(x=>({coachId:x.coachId, kid:x.kid}));
              // each involved coach cell conflict
              for (const x of arr){
                conflicts.add(`${day.id}|${s}|${x.coachId}`);
              }
            }
          }
        }
      }
      return { conflicts, details };
    }

    function applyConflictUI(){
      const { conflicts } = computeConflicts();

      // clear all first
      els.scheduleTable.querySelectorAll("td[data-day]").forEach(td=>{
        td.classList.remove("conflict");
      });

      // apply
      conflicts.forEach(key=>{
        const [dayId, slotStr, coachId] = key.split("|");
        const td = els.scheduleTable.querySelector(`td[data-day="${dayId}"][data-slot="${slotStr}"][data-coach="${coachId}"]`);
        if (td) td.classList.add("conflict");
      });
    }

    /***********************
     *  SIDE PANEL + SUMMARY
     ***********************/
    function buildWeekStats(){
      // totals
      let totalEntries = 0;  // total kid occurrences across all
      let totalUniqueKids = new Set();
      let conflictCount = 0;

      const byCoach = {};
      for (const c of COACHES){
        byCoach[c.id] = {
          name: c.name,
          entries: 0,
          uniqueKids: new Set(),
          byDay: Object.fromEntries(DAYS.map(d=>[d.id, 0]))
        };
      }

      const conflictInfo = computeConflicts();
      conflictCount = conflictInfo.conflicts.size;

      for (const day of DAYS){
        for (let s=0; s<TIME_SLOTS.length; s++){
          for (const c of COACHES){
            const kids = (weekData.data?.[day.id]?.[s]?.[c.id]) || [];
            for (const kid of kids){
              totalEntries++;
              totalUniqueKids.add(kid.trim().toLowerCase());
              byCoach[c.id].entries++;
              byCoach[c.id].uniqueKids.add(kid.trim().toLowerCase());
              byCoach[c.id].byDay[day.id] += 1;
            }
          }
        }
      }

      // convert sets to counts + keep sample list for summary
      const coachArr = COACHES.map(c=>{
        const o = byCoach[c.id];
        return {
          id: c.id,
          name: o.name,
          entries: o.entries,
          uniqueCount: o.uniqueKids.size,
          byDay: o.byDay
        };
      });

      return {
        totalEntries,
        totalUnique: totalUniqueKids.size,
        conflictCells: conflictCount,
        coachArr
      };
    }

    function renderSidePanel(){
      const stats = buildWeekStats();
      const weekISO = toISODate(currentWeekStart);

      const blocks = [];

      blocks.push(`
        <div class="sideRow">
          <div class="stat">
            <div class="k">Ment√©s kulcs</div>
            <div class="v" style="font-size:13px;font-weight:800;letter-spacing:.2px;">${escapeHtml(getWeekKey(weekISO))}</div>
          </div>
        </div>
      `);

      blocks.push(`
        <div class="sideRow">
          <div class="stat">
            <div class="k">√ñsszes bejegyz√©s</div>
            <div class="v">${stats.totalEntries}</div>
          </div>
          <div class="stat" style="text-align:right;">
            <div class="k">Egyedi gyerek (kb.)</div>
            <div class="v">${stats.totalUnique}</div>
          </div>
        </div>
      `);

      blocks.push(`
        <div class="sideRow">
          <div class="stat">
            <div class="k">√útk√∂z√©ses cell√°k</div>
            <div class="v" style="color:${stats.conflictCells ? "#fecaca" : "#d1fae5"}">${stats.conflictCells}</div>
          </div>
          <div class="mini" style="max-width: 180px; text-align:right;">
            ${stats.conflictCells ? "Piros keret jelzi az azonos id≈ës√°vban dupl√°n szerepl≈ë gyereket." : "Nincs √ºtk√∂z√©s."}
          </div>
        </div>
      `);

      blocks.push(`<div class="hr"></div>`);
      blocks.push(`<div class="mini" style="font-weight:800;color:#f3f4f6;margin-bottom:8px;">Edz≈ënk√©nt</div>`);

      for (const c of stats.coachArr){
        blocks.push(`
          <div class="sideRow">
            <div class="stat">
              <div class="k">${escapeHtml(c.name)}</div>
              <div class="v" style="font-size:14px;">${c.entries} <span class="mini">bejegyz√©s</span></div>
            </div>
            <div class="stat" style="text-align:right;">
              <div class="k">Egyedi</div>
              <div class="v" style="font-size:14px;">${c.uniqueCount}</div>
            </div>
          </div>
        `);
      }

      blocks.push(`<div class="hr"></div>`);
      blocks.push(`<div class="mini">Read-only megoszt√°s: <b>Megoszt√°s</b> gomb ‚Üí link m√°sol√°sa.</div>`);

      els.sidePanel.innerHTML = blocks.join("");
    }

    function renderSummaryModal(){
      const weekEnd = addDays(currentWeekStart, 6);
      els.summaryMeta.textContent = `${formatHU(currentWeekStart)} ‚Äì ${formatHU(weekEnd)}`;

      // Build detailed per-coach summary: totals + per-day + unique kids list
      const byCoachKids = {};
      for (const c of COACHES){
        byCoachKids[c.id] = {
          name: c.name,
          entries: 0,
          unique: new Map(), // lower -> original first-seen
          byDay: Object.fromEntries(DAYS.map(d=>[d.id, 0]))
        };
      }

      for (const day of DAYS){
        for (let s=0; s<TIME_SLOTS.length; s++){
          for (const c of COACHES){
            const kids = (weekData.data?.[day.id]?.[s]?.[c.id]) || [];
            for (const kid of kids){
              byCoachKids[c.id].entries++;
              byCoachKids[c.id].byDay[day.id] += 1;
              const k = kid.trim();
              const lower = k.toLowerCase();
              if (!byCoachKids[c.id].unique.has(lower)){
                byCoachKids[c.id].unique.set(lower, k);
              }
            }
          }
        }
      }

      // conflicts details
      const conflictInfo = computeConflicts();
      const conflictBlocks = [];
      const conflictKeys = Object.keys(conflictInfo.details);
      if (conflictKeys.length){
        conflictBlocks.push(`<div class="hint" style="margin: 8px 0 10px; color:#fecaca; font-weight:800;">‚ö†Ô∏è √útk√∂z√©sek r√©szletei (nap + id≈ës√°v):</div>`);
        conflictKeys.forEach(slotKey=>{
          const [dayId, slotStr] = slotKey.split("|");
          const dayLabel = DAYS.find(d=>d.id===dayId)?.label || dayId;
          const slotLabel = TIME_SLOTS[parseInt(slotStr,10)] || slotStr;

          const kidMap = conflictInfo.details[slotKey];
          const lines = [];
          Object.keys(kidMap).forEach(kidLower=>{
            const occ = kidMap[kidLower]; // [{coachId,kid}]
            const who = occ.map(x=>{
              const coachName = COACHES.find(c=>c.id===x.coachId)?.name || x.coachId;
              return coachName;
            }).join(", ");
            lines.push(`<div class="mini">‚Ä¢ <b>${escapeHtml(occ[0].kid)}</b> ‚Üí ${escapeHtml(who)}</div>`);
          });

          conflictBlocks.push(`
            <div style="margin: 8px 0 12px; padding:10px 12px; border-radius: 16px; border:1px solid rgba(239,68,68,.25); background: rgba(239,68,68,.08);">
              <div style="font-weight:800; margin-bottom:6px;">${escapeHtml(dayLabel)} ¬∑ ${escapeHtml(slotLabel)}</div>
              ${lines.join("")}
            </div>
          `);
        });
      } else {
        conflictBlocks.push(`<div class="hint" style="margin: 8px 0 10px; color:#d1fae5; font-weight:800;">‚úÖ Nincs √ºtk√∂z√©s ezen a h√©ten.</div>`);
      }

      // Build summary table
      const head = `
        <table class="summaryTable" aria-label="Heti √∂sszes√≠t≈ë t√°bl√°zat">
          <thead>
            <tr>
              <th>Edz≈ë</th>
              <th>√ñsszes bejegyz√©s</th>
              <th>Egyedi gyerek</th>
              <th>Napi bont√°s</th>
              <th>Gyerekek (egyedi)</th>
            </tr>
          </thead>
          <tbody>
      `;

      const rows = [];
      for (const c of COACHES){
        const o = byCoachKids[c.id];
        const dayBreak = DAYS.map(d=>{
          const v = o.byDay[d.id];
          return `${d.label.slice(0,3)}: ${v}`;
        }).join(" ¬∑ ");

        const kids = Array.from(o.unique.values()).sort((a,b)=>a.localeCompare(b, "hu"));
        const chips = kids.length
          ? `<div class="chips">${kids.map(k=>`<span class="chip">${escapeHtml(k)}</span>`).join("")}</div>`
          : `<span class="hint">‚Äî</span>`;

        rows.push(`
          <tr>
            <td style="font-weight:900;">${escapeHtml(o.name)}</td>
            <td>${o.entries}</td>
            <td>${o.unique.size}</td>
            <td class="mini">${escapeHtml(dayBreak)}</td>
            <td>${chips}</td>
          </tr>
        `);
      }

      const foot = `</tbody></table>`;

      els.summaryBody.innerHTML = `
        <div class="hint" style="margin-bottom:10px;">
          2-es funkci√≥: itt l√°tod edz≈ënk√©nt az √∂sszes bejegyz√©st, az egyedi gyerekeket, napi bont√°st, √©s az √ºtk√∂z√©seket.
        </div>
        ${head + rows.join("") + foot}
        <div style="margin-top:14px;">${conflictBlocks.join("")}</div>
      `;
    }

    function getSummaryTextForClipboard(){
      const weekEnd = addDays(currentWeekStart, 6);
      const lines = [];
      lines.push(`Heti √∂sszes√≠t≈ë: ${formatHU(currentWeekStart)} ‚Äì ${formatHU(weekEnd)}`);
      lines.push("");

      // per coach
      for (const c of COACHES){
        const unique = new Map();
        let entries = 0;
        const byDay = Object.fromEntries(DAYS.map(d=>[d.id, 0]));

        for (const day of DAYS){
          for (let s=0; s<TIME_SLOTS.length; s++){
            const kids = (weekData.data?.[day.id]?.[s]?.[c.id]) || [];
            for (const kid of kids){
              entries++;
              byDay[day.id] += 1;
              const k = kid.trim();
              const lower = k.toLowerCase();
              if (!unique.has(lower)) unique.set(lower, k);
            }
          }
        }

        lines.push(`${c.name}: ${entries} bejegyz√©s ¬∑ ${unique.size} egyedi gyerek`);
        lines.push(`  Napi bont√°s: ${DAYS.map(d=>`${d.label.slice(0,3)} ${byDay[d.id]}`).join(" | ")}`);
        const kidsList = Array.from(unique.values()).sort((a,b)=>a.localeCompare(b,"hu"));
        lines.push(`  Gyerekek: ${kidsList.length ? kidsList.join(", ") : "‚Äî"}`);
        lines.push("");
      }

      // conflicts
      const conflictInfo = computeConflicts();
      const conflictKeys = Object.keys(conflictInfo.details);
      if (conflictKeys.length){
        lines.push("√úTK√ñZ√âSEK:");
        conflictKeys.forEach(slotKey=>{
          const [dayId, slotStr] = slotKey.split("|");
          const dayLabel = DAYS.find(d=>d.id===dayId)?.label || dayId;
          const slotLabel = TIME_SLOTS[parseInt(slotStr,10)] || slotStr;
          lines.push(`- ${dayLabel} / ${slotLabel}`);
          const kidMap = conflictInfo.details[slotKey];
          Object.keys(kidMap).forEach(kidLower=>{
            const occ = kidMap[kidLower];
            const who = occ.map(x=>{
              const coachName = COACHES.find(c=>c.id===x.coachId)?.name || x.coachId;
              return coachName;
            }).join(", ");
            lines.push(`  ‚Ä¢ ${occ[0].kid} -> ${who}`);
          });
        });
      } else {
        lines.push("√úTK√ñZ√âSEK: nincs");
      }

      return lines.join("\n");
    }

    /***********************
     *  EDIT MODAL
     ***********************/
    function openEdit(dayId, slotIndex, coachId){
      editCtx = { dayId, slotIndex, coachId };

      const dIdx = DAYS.findIndex(d=>d.id===dayId);
      const date = addDays(currentWeekStart, dIdx);
      const dayLabel = DAYS.find(d=>d.id===dayId)?.label || dayId;
      const coachName = COACHES.find(c=>c.id===coachId)?.name || coachId;

      const kids = (weekData.data?.[dayId]?.[slotIndex]?.[coachId]) || [];

      els.editTitle.textContent = `Szerkeszt√©s: ${coachName}`;
      els.editMeta.textContent = `${dayLabel} ¬∑ ${formatHU(date)} ¬∑ ${TIME_SLOTS[slotIndex]}`;

      els.kidsInput.value = kids.join("\n");
      els.conflictHint.style.display = "none";

      els.editOverlay.classList.add("show");
      setTimeout(()=>els.kidsInput.focus(), 40);

      // show conflict hint if needed (based on current list)
      refreshEditConflictHint();
    }

    function closeEdit(){
      els.editOverlay.classList.remove("show");
      editCtx = null;
    }

    function refreshEditConflictHint(){
      if (!editCtx) return;

      const proposed = normalizeKidsText(els.kidsInput.value);
      // Temporarily check conflicts if this cell would be set to proposed
      const original = (weekData.data?.[editCtx.dayId]?.[editCtx.slotIndex]?.[editCtx.coachId]) || [];
      weekData.data[editCtx.dayId][editCtx.slotIndex][editCtx.coachId] = proposed;

      const conflictInfo = computeConflicts();
      const key = `${editCtx.dayId}|${editCtx.slotIndex}|${editCtx.coachId}`;
      const has = conflictInfo.conflicts.has(key);

      // revert
      weekData.data[editCtx.dayId][editCtx.slotIndex][editCtx.coachId] = original;

      els.conflictHint.style.display = has ? "block" : "none";
    }

    function saveEdit(){
      if (!editCtx || readOnly) return;

      const kids = normalizeKidsText(els.kidsInput.value);

      weekData.data[editCtx.dayId][editCtx.slotIndex][editCtx.coachId] = kids;
      saveWeekToStorage();
      renderAll();
      closeEdit();
      toast("Mentve");
    }

    function clearCell(){
      if (!editCtx || readOnly) return;
      els.kidsInput.value = "";
      refreshEditConflictHint();
      toast("T√∂r√∂lve (m√©g nincs mentve)");
    }

    /***********************
     *  SUMMARY MODAL
     ***********************/
    function openSummary(){
      renderSummaryModal();
      els.summaryOverlay.classList.add("show");
    }
    function closeSummary(){
      els.summaryOverlay.classList.remove("show");
    }

    /***********************
     *  SHARE MODAL
     ***********************/
    function openShare(){
      // Create share payload from current weekData
      const payload = {
        weekStartISO: toISODate(currentWeekStart),
        data: weekData.data
      };
      const encoded = b64encodeUnicode(payload);

      const base = location.href.split("#")[0];
      const link = `${base}#view=${encoded}`;
      els.shareLink.value = link;

      els.shareOverlay.classList.add("show");
      setTimeout(()=>els.shareLink.select(), 40);
    }
    function closeShare(){
      els.shareOverlay.classList.remove("show");
    }

    /***********************
     *  EXPORT / IMPORT
     ***********************/
    function doExport(){
      const payload = {
        app: "DAK Edz≈ëi nyilv√°ntart√°s",
        exportedAt: new Date().toISOString(),
        weekStartISO: toISODate(currentWeekStart),
        data: weekData.data
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `dak_beosztas_${payload.weekStartISO}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Export k√©sz");
    }

    async function doImportFromFile(file){
      if (readOnly) return;

      const text = await file.text();
      const parsed = safeJsonParse(text);

      if (!parsed || !parsed.weekStartISO || !parsed.data){
        toast("Import hiba: rossz f√°jl");
        return;
      }

      // import week specified by file into current week
      currentWeekStart = getMonday(new Date(parsed.weekStartISO));
      weekData = {
        weekStartISO: toISODate(currentWeekStart),
        data: parsed.data
      };

      saveWeekToStorage();
      renderAll();
      toast("Import k√©sz");
    }

    /***********************
     *  RENDER ALL
     ***********************/
    function renderAll(){
      renderTable();
      applyConflictUI();
      renderSidePanel();
    }

    /***********************
     *  NAV
     ***********************/
    function gotoWeek(startDate){
      currentWeekStart = getMonday(startDate);

      if (!readOnly){
        loadWeekFromStorage();
      } else {
        // read-only share view: week already inside weekData
        weekData.weekStartISO = toISODate(currentWeekStart);
      }

      renderAll();
    }

    /***********************
     *  EVENTS
     ***********************/
    els.prevWeekBtn.addEventListener("click", ()=>{
      const d = addDays(currentWeekStart, -7);
      setReadOnlyMode(false); // navigating normally should exit read-only (if user wants)
      history.replaceState(null, "", location.href.split("#")[0]); // remove share hash
      loadWeekFromStorage(); // ensure normal mode
      gotoWeek(d);
      toast("El≈ëz≈ë h√©t");
    });

    els.nextWeekBtn.addEventListener("click", ()=>{
      const d = addDays(currentWeekStart, 7);
      setReadOnlyMode(false);
      history.replaceState(null, "", location.href.split("#")[0]);
      loadWeekFromStorage();
      gotoWeek(d);
      toast("K√∂vetkez≈ë h√©t");
    });

    els.todayBtn.addEventListener("click", ()=>{
      setReadOnlyMode(false);
      history.replaceState(null, "", location.href.split("#")[0]);
      loadWeekFromStorage();
      gotoWeek(new Date());
      toast("Aktu√°lis h√©t");
    });

    els.clearWeekBtn.addEventListener("click", ()=>{
      if (readOnly) return;
      if (!confirm("Biztos t√∂rl√∂d ENNEK a h√©tnek az adatait?")) return;
      clearWeekStorage();
    });

    els.exportBtn.addEventListener("click", doExport);

    els.importBtn.addEventListener("click", ()=>{
      if (readOnly) return;
      els.fileInput.value = "";
      els.fileInput.click();
    });

    els.fileInput.addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if (file) doImportFromFile(file);
    });

    els.shareBtn.addEventListener("click", openShare);

    els.copyWeekKeyBtn.addEventListener("click", async ()=>{
      const weekISO = toISODate(currentWeekStart);
      const key = getWeekKey(weekISO);
      try{
        await navigator.clipboard.writeText(key);
        toast("Kulcs m√°solva");
      }catch{
        toast("Nem siker√ºlt m√°solni");
      }
    });

    // Edit modal buttons
    els.closeEditBtn.addEventListener("click", closeEdit);
    els.cancelEditBtn.addEventListener("click", closeEdit);
    els.saveEditBtn.addEventListener("click", saveEdit);
    els.clearCellBtn.addEventListener("click", clearCell);
    els.kidsInput.addEventListener("input", refreshEditConflictHint);

    els.editOverlay.addEventListener("click", (e)=>{
      if (e.target === els.editOverlay) closeEdit();
    });

    // Summary modal
    els.summaryBtn.addEventListener("click", ()=>{
      openSummary();
    });
    els.closeSummaryBtn.addEventListener("click", closeSummary);
    els.closeSummaryBtn2.addEventListener("click", closeSummary);
    els.summaryOverlay.addEventListener("click", (e)=>{
      if (e.target === els.summaryOverlay) closeSummary();
    });
    els.copySummaryBtn.addEventListener("click", async ()=>{
      const txt = getSummaryTextForClipboard();
      try{
        await navigator.clipboard.writeText(txt);
        toast("√ñsszes√≠t≈ë m√°solva");
      }catch{
        toast("Nem siker√ºlt m√°solni");
      }
    });

    // Share modal
    els.closeShareBtn.addEventListener("click", closeShare);
    els.closeShareBtn2.addEventListener("click", closeShare);
    els.shareOverlay.addEventListener("click", (e)=>{
      if (e.target === els.shareOverlay) closeShare();
    });
    els.copyShareBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(els.shareLink.value);
        toast("Link m√°solva");
      }catch{
        toast("Nem siker√ºlt m√°solni");
      }
    });
    els.openShareBtn.addEventListener("click", ()=>{
      window.open(els.shareLink.value, "_blank");
    });

    // Keyboard
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape"){
        if (els.editOverlay.classList.contains("show")) closeEdit();
        if (els.summaryOverlay.classList.contains("show")) closeSummary();
        if (els.shareOverlay.classList.contains("show")) closeShare();
      }
      // Ctrl+S quick save in modal
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
        if (els.editOverlay.classList.contains("show")){
          e.preventDefault();
          saveEdit();
        }
      }
    });

    /***********************
     *  INIT
     ***********************/
    (function init(){
      // 1) if shared view in hash -> load it and set readOnly
      const shared = tryLoadSharedView();
      if (shared){
        setReadOnlyMode(true);
        renderAll();
        toast("Read-only n√©zet");
        return;
      }

      // 2) normal mode: load current week from storage
      setReadOnlyMode(false);
      loadWeekFromStorage();
      renderAll();
    })();
  </script>
</body>
</html>
