<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DAK Edzői nyilvántartás</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --text:#e8eefc;
      --muted:#9db0d3;
      --line:#223055;
      --accent:#7c5cff;
      --accent2:#18d6a1;
      --warn:#ffcc66;
      --danger:#ff5c7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --chip:#1b2750;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(124,92,255,.25), transparent 55%),
                  radial-gradient(1100px 800px at 90% 10%, rgba(24,214,161,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px;}
    .brand{
      display:flex; gap:10px; align-items:center;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      min-width:280px;
    }
    .dot{width:12px;height:12px;border-radius:999px;background: linear-gradient(180deg,var(--accent), var(--accent2));
      box-shadow: 0 0 0 4px rgba(124,92,255,.15); flex:0 0 auto; margin-top:3px;}
    .brand h1{margin:0;font-size:16px}
    .brand .sub{color:var(--muted);font-size:12px;margin-top:2px}

    .panel{
      flex:1;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:12px;
      min-width: 320px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row + .row{margin-top:10px}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color:var(--text);
      padding:9px 12px;border-radius:14px;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .05s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{border-color: rgba(124,92,255,.45)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(180deg, rgba(124,92,255,.30), rgba(124,92,255,.12));
    }
    .btn.danger{
      border-color: rgba(255,92,122,.45);
      background: linear-gradient(180deg, rgba(255,92,122,.22), rgba(255,92,122,.08));
    }
    .btn.ok{
      border-color: rgba(24,214,161,.45);
      background: linear-gradient(180deg, rgba(24,214,161,.22), rgba(24,214,161,.08));
    }
    .input{
      flex:1;
      background: rgba(10,15,30,.55);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 12px;border-radius:14px;
      outline:none;
      min-width: 220px;
    }
    .input::placeholder{color: rgba(157,176,211,.7)}
    .weekbox{display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12px;}
    .weekbox b{color:var(--text);font-size:13px}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(124,92,255,.12);
    }

    .summaryWrap{
      margin-top:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .summaryHead{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .summaryTitle{font-weight:800}
    .summarySub{color:var(--muted); font-size:12px}
    .summaryGrid{display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px;}
    @media (max-width: 980px){ .summaryGrid{grid-template-columns:1fr} }
    .sumCard{
      background: rgba(10,15,30,.35);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding:12px;
    }
    .sumName{font-weight:800; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .sumTag{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(24,214,161,.10);
      white-space:nowrap;
    }
    .sumMetrics{display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px;}
    @media (max-width: 560px){ .sumMetrics{grid-template-columns: 1fr} }
    .metric{
      background: rgba(17,26,46,.35);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding:10px;
    }
    .metric .k{color:var(--muted); font-size:11px}
    .metric .v{font-weight:900; font-size:16px; margin-top:3px}
    .metric .s{color:var(--muted); font-size:11px; margin-top:2px}

    .hint{color: var(--muted); font-size:12px; margin-top:10px; display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;}
    .hint kbd{
      font: 11px/1.1 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      padding:3px 6px; border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,30,.45);
      color: var(--text);
    }

    .tableWrap{
      margin-top:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;}
    thead th{position:sticky; top:0;background: rgba(17,26,46,.92);backdrop-filter: blur(8px);z-index:2;}
    th, td{border-bottom:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.06); padding:10px; vertical-align:top;}
    th:first-child, td:first-child{border-left:1px solid rgba(255,255,255,.06)}
    thead tr:first-child th{border-top:1px solid rgba(255,255,255,.06)}
    thead .coach{text-align:center;font-weight:700;color:var(--text);padding:12px 10px;}
    thead .slot{text-align:center;font-weight:600;color:var(--muted);font-size:12px;padding:8px 10px;}
    .dayCell{width:160px;background: rgba(10,15,30,.35);}
    .dayName{font-weight:700;margin:0 0 4px 0;font-size:13px;}
    .dateText{color:var(--muted); font-size:12px}
    td{background: rgba(15,23,48,.40);}
    td.cell{min-height:74px;cursor:pointer;}
    td.cell:hover{background: rgba(124,92,255,.08);}
    td.cell.conflict{box-shadow: inset 0 0 0 2px rgba(255,204,102,.35);}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      background: rgba(27,39,80,.75);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:5px 8px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex; gap:6px; align-items:center;
      max-width:100%;
    }
    .chip.warn{border-color: rgba(255,204,102,.55); box-shadow: 0 0 0 3px rgba(255,204,102,.10);}
    .chip .x{
      display:inline-block; width:16px;height:16px; line-height:14px; text-align:center;
      border-radius:999px; background: rgba(255,255,255,.08);
      color: rgba(232,238,252,.9); font-size:12px;
    }
    .chip .x:hover{background: rgba(255,92,122,.18)}
    .cellFooter{margin-top:8px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:11px;}
    .plus{
      width:26px;height:26px;border-radius:12px;
      border:1px dashed rgba(255,255,255,.16);
      display:inline-flex; align-items:center; justify-content:center;
      color: rgba(232,238,252,.9);
      background: rgba(10,15,30,.35);
      font-weight:700;
    }

    .backdrop{position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:50;}
    .backdrop.show{display:flex}
    .modal{
      width:min(680px, 100%);
      background: linear-gradient(180deg, rgba(17,26,46,.98), rgba(15,23,48,.98));
      border:1px solid rgba(255,255,255,.08);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{padding:14px 16px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; border-bottom:1px solid rgba(255,255,255,.06);}
    .modalHeader h2{margin:0;font-size:15px}
    .modalHeader .meta{color:var(--muted);font-size:12px;margin-top:3px}
    .modalBody{padding:14px 16px}
    .modalFooter{padding:14px 16px; border-top:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .suggestions{display:flex; flex-wrap:wrap; gap:6px; max-height: 96px; overflow:auto; padding-bottom:2px;}
    .pill{
      cursor:pointer; border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,30,.35);
      color: var(--text); font-size:12px;
    }
    .pill:hover{border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.10)}
    .warnline{display:none;color: var(--warn);font-size:12px;margin-top:8px;}
    .warnline.show{display:block}

    .results{
      margin-top:10px; border-top:1px solid rgba(255,255,255,.06);
      padding-top:10px; color: var(--muted); font-size:12px; display:none;
    }
    .results.show{display:block}
    .resItem{
      padding:6px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      border-bottom:1px dashed rgba(255,255,255,.06);
    }
    .resItem:last-child{border-bottom:none}
    .tag{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(24,214,161,.10);
      color: var(--text);
    }

    @media print{
      body{background:#fff;color:#000}
      .topbar, .hint, .modal, .backdrop, .summaryWrap{display:none !important}
      .tableWrap{box-shadow:none; border:none; border-radius:0}
      thead th{position:static;background:#fff;color:#000}
      th, td{border:1px solid #ddd !important;background:#fff !important;color:#000 !important}
      .chip{background:#f3f3f3 !important;color:#000 !important;border:1px solid #ddd !important}
      .plus, .cellFooter{display:none !important}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <h1>DAK Edzői nyilvántartás</h1>
        <div class="sub" id="modeLine">Szerkesztő mód — automatikus mentés</div>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="weekbox">
          <span class="badge" id="weekLabel">Szerkesztés</span>
          <div>
            <div><b id="weekRangeText">—</b></div>
            <div class="small" id="weekStartText">—</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="prevWeekBtn">← Előző</button>
          <button class="btn" id="todayWeekBtn">Ma</button>
          <button class="btn primary" id="copyPrevWeekBtn" title="Az előző hét teljes beosztását átmásolja erre a hétre">Másolás előző hétről</button>
          <button class="btn" id="nextWeekBtn">Következő →</button>
        </div>
      </div>

      <div class="row">
        <input class="input" id="searchInput" placeholder="Gyerek keresése (pl. Martin)" />
        <button class="btn" id="clearSearchBtn">Törlés</button>
        <button class="btn" id="historyBtn" title="Gyerek történet több hétre">Történet</button>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <a class="btn" id="openViewBtn" href="view.html" target="_blank" rel="noopener">Szülői nézet megnyitása</a>
          <button class="btn ok" id="publishBtn" title="Letölti a public.json fájlt, amit fel kell töltened a repóba">Publikus frissítés (public.json)</button>
          <button class="btn" id="monthBtn" title="Havi összesítő (napok, órák, gyerekek)">Havi összesítő</button>
          <button class="btn" id="printBtn">Nyomtatás / PDF</button>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="exportBtn">Export</button>
          <label class="btn" for="importFile" style="cursor:pointer">Import</label>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn danger" id="resetWeekBtn" title="Csak az aktuális hét törlése">Hét törlése</button>
        </div>
      </div>

      <div class="results" id="searchResults"></div>
    </div>
  </div>

  <div class="summaryWrap">
    <div class="summaryHead">
      <div>
        <div class="summaryTitle">Heti összesítő</div>
        <div class="summarySub" id="summarySub">—</div>
      </div>
      <div class="summarySub">Max: <b>nincs korlát</b></div>
    </div>
    <div class="summaryGrid" id="summaryGrid"></div>
  </div>

  <div class="hint">
    <span>Tippek:</span>
    <span><kbd>Katt</kbd> a cellára → név hozzáadás/törlés</span>
    <span>Nincs létszámkorlát / cella</span>
    <span>Ütközés jelzés: ugyanaz a név ugyanabban az idősávban több edzőnél</span>
  </div>

  <div class="tableWrap">
    <table id="scheduleTable"></table>
  </div>
</div>

<div class="backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2 id="modalTitle">Cellaszerkesztés</h2>
        <div class="meta" id="modalMeta">—</div>
      </div>
      <button class="btn" id="closeModalBtn">Bezár</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <input class="input" id="nameInput" placeholder="Írj be egy nevet, majd Enter" />
        <button class="btn primary" id="addNameBtn">Hozzáad</button>
      </div>
      <div class="warnline" id="limitWarn">Elérted a maximumot.</div>

      <div class="divider"></div>

      <div class="small">Jelenlegi nevek ebben a cellában:</div>
      <div style="margin-top:8px" class="chips" id="modalChips"></div>

      <div class="divider"></div>

      <div class="small">Javaslatok (korábbi nevekből):</div>
      <div class="suggestions" id="suggestions"></div>
    </div>
    <div class="modalFooter">
      <div class="small" id="conflictHint">—</div>
      <div class="row">
        <button class="btn" id="clearCellBtn">Cella ürítése</button>
        <button class="btn primary" id="doneBtn">Kész</button>
      </div>
    </div>
  </div>

</div>

<!-- Havi összesítő modal -->
<div class="backdrop" id="monthBackdrop" aria-hidden="true">
  <div class="modal" style="width:min(860px, 100%)">
    <div class="modal-head">
      <div>
        <div class="modal-title">Havi összesítő</div>
        <div class="muted" style="margin-top:2px">Kiválasztott hónap edzőnként: napok, órák, gyerek alkalmak, egyedi gyerekek</div>
      </div>
      <button class="iconbtn" id="monthCloseBtn" title="Bezárás">✕</button>
    </div>
    <div class="modal-body">
      <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
        <label class="pill" style="display:flex; gap:8px; align-items:center">
          <span class="muted">Hónap:</span>
          <input id="monthPicker" type="month" style="background:transparent;border:0;color:var(--text);font:inherit;outline:none" />
        </label>
        <button class="btn" id="monthRefreshBtn">Frissítés</button>
        <div class="muted" id="monthInfo"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-title">Edzői bontás</div>
        <div id="monthTableWrap" style="overflow:auto; margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-title">Számítás</div>
        <div class="muted" style="line-height:1.5">
          • <b>Nap</b>: amikor az adott edzőnél legalább 1 idősávban van beírt gyerek.<br/>
          • <b>Óra</b>: foglalt idősávok száma × 1 óra (egy idősáv egy óra).<br/>
          • <b>Gyerek alkalom</b>: beírt nevek összesen (ha 2 gyerek van ugyanabban az órában, az +2).<br/>
          • <b>Egyedi gyerek</b>: különböző nevek száma a hónapban.
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Gyerek történet / több hét -->
<div class="backdrop" id="historyBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:980px">
    <div class="modalHeader">
      <div>
        <h2 id="historyTitle">Gyerek történet</h2>
        <div class="meta" id="historyMeta">—</div>
      </div>
      <button class="btn" id="historyCloseBtn">Bezár</button>
    </div>
    <div class="modalBody">
      <div class="row" style="gap:10px">
        <input class="input" id="historyNameInput" placeholder="Írd be a gyerek nevét (pl. Martin)" />
        <button class="btn primary" id="historyRunBtn">Keresés</button>
        <button class="btn" id="historyClearBtn">Törlés</button>
      </div>
      <div class="divider"></div>
      <div id="historyStats" class="small">—</div>
      <div style="height:10px"></div>
      <div id="historyWrap"></div>
    </div>
  </div>
</div>
<script>
(() => {
  const COACHES = ["Bálint Zsolt", "Bakos Péter", "Somogyi Gábor"];
  const DEFAULT_SLOTS = ["17:00", "18:00"];
  const DAYS = [
    { name: "Hétfő" },
    { name: "Kedd" },
    { name: "Szerda" },
    { name: "Csütörtök" },
    { name: "Péntek" }
  ];
  const STORAGE_KEY = "dak_schedule_v2";
  const MAX_PER_CELL = 99; // korlát kikapcsolva (régen 3)
  const SLOT_DURATION_HOURS = 1; // 17:00/18:00 = 1 óra / idősáv

  let state = {
    currentWeekStart: mondayOf(new Date()),
    db: loadDB(),
    sel: null,
    search: ""
  };

  const elTable = document.getElementById("scheduleTable");
  const weekRangeText = document.getElementById("weekRangeText");
  const weekStartText = document.getElementById("weekStartText");
  const weekLabel = document.getElementById("weekLabel");

  const summarySub = document.getElementById("summarySub");
  const summaryGrid = document.getElementById("summaryGrid");

  const prevWeekBtn = document.getElementById("prevWeekBtn");
  const nextWeekBtn = document.getElementById("nextWeekBtn");
  const todayWeekBtn = document.getElementById("todayWeekBtn");
  const copyPrevWeekBtn = document.getElementById("copyPrevWeekBtn");

  const searchInput = document.getElementById("searchInput");
  const clearSearchBtn = document.getElementById("clearSearchBtn");
  const searchResults = document.getElementById("searchResults");

  const openViewBtn = document.getElementById("openViewBtn");
  const publishBtn = document.getElementById("publishBtn");
  const monthBtn = document.getElementById("monthBtn");
  const historyBtn = document.getElementById("historyBtn");
  const printBtn = document.getElementById("printBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importFile = document.getElementById("importFile");
  const resetWeekBtn = document.getElementById("resetWeekBtn");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const monthBackdrop = document.getElementById("monthBackdrop");
  const monthCloseBtn = document.getElementById("monthCloseBtn");
  const monthPicker = document.getElementById("monthPicker");
  const monthRefreshBtn = document.getElementById("monthRefreshBtn");
  const monthInfo = document.getElementById("monthInfo");
  const monthTableWrap = document.getElementById("monthTableWrap");

  const historyBackdrop = document.getElementById("historyBackdrop");
  const historyCloseBtn = document.getElementById("historyCloseBtn");
  const historyTitle = document.getElementById("historyTitle");
  const historyMeta = document.getElementById("historyMeta");
  const historyNameInput = document.getElementById("historyNameInput");
  const historyRunBtn = document.getElementById("historyRunBtn");
  const historyClearBtn = document.getElementById("historyClearBtn");
  const historyStats = document.getElementById("historyStats");
  const historyWrap = document.getElementById("historyWrap");
  const historyStats = document.getElementById("historyStats");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const doneBtn = document.getElementById("doneBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalMeta = document.getElementById("modalMeta");
  const nameInput = document.getElementById("nameInput");
  const addNameBtn = document.getElementById("addNameBtn");
  const modalChips = document.getElementById("modalChips");
  const suggestions = document.getElementById("suggestions");
  const limitWarn = document.getElementById("limitWarn");
  const clearCellBtn = document.getElementById("clearCellBtn");
  const conflictHint = document.getElementById("conflictHint");

  prevWeekBtn.addEventListener("click", () => shiftWeek(-7));
  nextWeekBtn.addEventListener("click", () => shiftWeek( 7));
  todayWeekBtn.addEventListener("click", () => setWeek(mondayOf(new Date())));

  copyPrevWeekBtn.addEventListener("click", () => {
    const currentWk = getWeekKey(state.currentWeekStart);
    const prevDate = new Date(state.currentWeekStart); prevDate.setDate(prevDate.getDate() - 7);
    const prevWk = getWeekKey(mondayOf(prevDate));
    const prevWeek = state.db.weeks?.[prevWk];
    if (!prevWeek) { alert("Az előző hét még üres / nincs adat, ezért nincs mit másolni."); return; }
    const currentWeek = ensureWeek(currentWk);
    const currentHasAny = weekHasAnyData(currentWeek);
    if (currentHasAny) { if (!confirm("A jelenlegi héten már van adat. Biztosan felülírod az egészet az előző hét alapján?")) return; }
    currentWeek.slots = Array.isArray(prevWeek.slots) ? prevWeek.slots.slice() : DEFAULT_SLOTS.slice();
    currentWeek.entries = deepClone(prevWeek.entries);
    saveDB(state.db);
    render();
    alert("Kész ✅ Az előző hét beosztása átmásolva erre a hétre.");
  });

  searchInput.addEventListener("input", () => { state.search = (searchInput.value || "").trim(); render(); });
  clearSearchBtn.addEventListener("click", () => { searchInput.value=""; state.search=""; render(); });

  printBtn.addEventListener("click", () => window.print());

  publishBtn.addEventListener("click", () => {
    // Publikus csomag: minden hét + config (szülők nézethez)
    const payload = buildPublicPayload();
    downloadJson("public.json", payload);
    alert("Letöltöttem a public.json fájlt ✅\n\nKövetkező lépés:\nGitHub → Upload files → töltsd fel a public.json-t a repó gyökerébe, és Commit.\n\nA szülők ezután a view.html linken a friss adatot látják.");
  });


  monthBtn.addEventListener("click", () => {
    openMonthModal();
  });
  monthCloseBtn.addEventListener("click", closeMonthModal);
  monthBackdrop.addEventListener("click", (e) => { if (e.target === monthBackdrop) closeMonthModal(); });
  monthRefreshBtn.addEventListener("click", () => renderMonthlySummary(monthPicker.value)
  // Gyerek történet (több hétre)
  historyBtn?.addEventListener("click", () => openHistoryModal(state.search || ""));
  function openHistoryModal(prefill){
    historyNameInput.value = (prefill || "").trim();
    historyTitle.textContent = "Gyerek történet";
    historyMeta.textContent = "Több hét / teljes adatbázis keresése";
    historyBackdrop.classList.add("show");
    historyBackdrop.setAttribute("aria-hidden","false");
    setTimeout(()=>historyNameInput.focus(),0);
    if (historyNameInput.value) renderHistory(historyNameInput.value);
  }
  function closeHistoryModal(){
    historyBackdrop.classList.remove("show");
    historyBackdrop.setAttribute("aria-hidden","true");
  }
  historyCloseBtn.addEventListener("click", closeHistoryModal);
  historyBackdrop.addEventListener("click", (e) => { if (e.target === historyBackdrop) closeHistoryModal(); });

  historyRunBtn.addEventListener("click", () => renderHistory(historyNameInput.value));
  historyNameInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderHistory(historyNameInput.value); });
  historyClearBtn.addEventListener("click", () => { historyNameInput.value=""; historyWrap.innerHTML=""; historyStats.textContent="—"; });

  function renderHistory(nameRaw){
    const name = (nameRaw||"").trim();
    const q = normName(name);
    if(!q){ historyStats.textContent="Írj be egy nevet."; historyWrap.innerHTML=""; return; }

    const hits = [];
    const perCoach = COACHES.map(()=>({cells:0, hours:0, days:new Set(), uniqueKids:new Set()}));

    // weeks sorted
    const weekKeys = Object.keys(state.db.weeks||{}).sort();
    for (const wk of weekKeys){
      const w = state.db.weeks[wk];
      const slots = w.slots || DEFAULT_SLOTS;
      const monday = new Date(wk + "T00:00:00");
      for (let dayIdx=0; dayIdx<DAYS.length; dayIdx++){
        const d = new Date(monday); d.setDate(d.getDate()+dayIdx);
        const dateISO = d.toISOString().slice(0,10);
        for (let coachIdx=0; coachIdx<COACHES.length; coachIdx++){
          for (let slotIdx=0; slotIdx<slots.length; slotIdx++){
            const names = getCellNames(w, dayIdx, coachIdx, slotIdx);
            if(!names.length) continue;
            // track unique kids per coach
            names.forEach(n=>perCoach[coachIdx].uniqueKids.add(prettifyName(n)));
            const matched = names.filter(n => normName(n).includes(q));
            if (matched.length){
              hits.push({wk, dateISO, dayIdx, coachIdx, slot: slots[slotIdx], matched, all:names});
              perCoach[coachIdx].cells += 1;
              perCoach[coachIdx].hours += SLOT_DURATION_HOURS;
              perCoach[coachIdx].days.add(dateISO);
            }
          }
        }
      }
    }

    hits.sort((a,b)=> a.dateISO.localeCompare(b.dateISO) || a.slot.localeCompare(b.slot) || a.coachIdx-b.coachIdx);

    const totalHours = hits.length * SLOT_DURATION_HOURS;
    const uniqWeeks = new Set(hits.map(h=>h.wk)).size;
    const uniqDays = new Set(hits.map(h=>h.dateISO)).size;

    historyStats.innerHTML = `
      <b style="color:var(--text)">${escapeHtml(name)}</b> • találatok: <b style="color:var(--text)">${hits.length}</b>
      • hetek: <b style="color:var(--text)">${uniqWeeks}</b>
      • napok: <b style="color:var(--text)">${uniqDays}</b>
      • össz óra (1 idősáv = ${SLOT_DURATION_HOURS} óra): <b style="color:var(--text)">${totalHours}</b>
    `;

    if(!hits.length){
      historyWrap.innerHTML = `<div class="small">Nincs találat a teljes adatbázisban.</div>`;
      return;
    }

    // per coach mini summary
    let coachHtml = '<div class="small" style="margin:6px 0 10px">Edzőnként:</div><div class="summaryGrid">';
    for (let i=0;i<COACHES.length;i++){
      const pc=perCoach[i];
      if(pc.cells===0) continue;
      coachHtml += `
        <div class="sumCard" style="min-width:220px">
          <div class="sumName"><span>${COACHES[i]}</span><span class="sumTag">${pc.days.size} nap • ${pc.hours} óra</span></div>
          <div class="sumMetrics">
            <div class="metric"><div class="k">Előfordulás</div><div class="v">${pc.cells}</div><div class="s">cellában</div></div>
            <div class="metric"><div class="k">Egyedi gyerekek</div><div class="v">${pc.uniqueKids.size}</div><div class="s">a hónapokban</div></div>
            <div class="metric"><div class="k">Napok</div><div class="v">${pc.days.size}</div><div class="s">összes</div></div>
          </div>
        </div>`;
    }
    coachHtml += "</div>";

    // results list
    let list = '<div class="divider"></div><div class="small">Részletek (időrendben):</div>';
    list += '<div style="margin-top:10px">';
    for (const h of hits){
      list += `
        <div class="resItem" style="cursor:pointer" data-wk="${h.wk}">
          <span class="tag">${h.dateISO} • ${DAYS[h.dayIdx].name} • ${h.slot}</span>
          <span><b style="color:var(--text)">${COACHES[h.coachIdx]}</b> → ${h.all.map(escapeHtml).join(", ")}</span>
        </div>`;
    }
    list += "</div>";

    historyWrap.innerHTML = coachHtml + list;

    // click → jump to week in editor
    historyWrap.querySelectorAll(".resItem[data-wk]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const wk = el.getAttribute("data-wk");
        if (wk){
          state.currentWeekStart = new Date(wk + "T00:00:00");
          state.search = name;
          closeHistoryModal();
          render();
        }
      });
    });
  }
);

  exportBtn.addEventListener("click", () => {
    downloadJson(`dak_export_${todayISO()}.json`, state.db);
  });

  importFile.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try{
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== "object" || !obj.weeks) throw new Error("Invalid");
      state.db = sanitizeDB(obj);
      saveDB(state.db);
      alert("Import sikeres ✅");
      render();
    } catch {
      alert("Import hiba: nem megfelelő JSON formátum.");
    } finally {
      importFile.value = "";
    }
  });

  resetWeekBtn.addEventListener("click", () => {
    const wk = getWeekKey(state.currentWeekStart);
    if (!confirm(`Biztos törlöd a(z) ${wk} héten lévő összes beosztást?`)) return;
    delete state.db.weeks[wk];
    saveDB(state.db);
    render();
  });

  closeModalBtn.addEventListener("click", closeModal);
  doneBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

  addNameBtn.addEventListener("click", () => addNameFromInput());
  nameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); addNameFromInput(); }
    else if (e.key === "Escape") closeModal();
  });

  clearCellBtn.addEventListener("click", () => {
    if (!state.sel) return;
    const {wk, dayIdx, coachIdx, slotIdx} = state.sel;
    setCellNames(wk, dayIdx, coachIdx, slotIdx, []);
    openModal(state.sel);
    render();
  });

  render();

  function render(){
    const wk = getWeekKey(state.currentWeekStart);
    const monday = new Date(wk + "T00:00:00");
    const friday = new Date(monday); friday.setDate(friday.getDate() + 4);

    weekRangeText.textContent = `${fmtDate(monday)} – ${fmtDate(friday)}`;
    weekStartText.textContent = `Hét kezdete: ${wk}`;
    weekLabel.textContent = "Szerkesztés";

    const weekObj = ensureWeek(wk);
    const slots = weekObj.slots || DEFAULT_SLOTS;

    // Szülői nézet nyitása: mindig ugyanaz a link, nincs adat URL-ben
    openViewBtn.href = `view.html`;

    renderSummary(weekObj, slots);

    const conflicts = computeConflicts(weekObj, slots);

    const thead = buildThead(slots);
    const tbody = buildTbody(weekObj, slots, conflicts);
    elTable.innerHTML = "";
    elTable.appendChild(thead);
    elTable.appendChild(tbody);

    renderSearch(weekObj, slots);
  }

  function renderSummary(weekObj, slots){
    const totalCellsPerCoach = DAYS.length * slots.length;
    summarySub.textContent = `Hét összes cellája edzőnként: ${totalCellsPerCoach} (napok: ${DAYS.length}, idősávok: ${slots.length})`;
    summaryGrid.innerHTML = "";
    for (let coachIdx=0; coachIdx<COACHES.length; coachIdx++){
      let kidCount = 0, filledCells = 0;
      for (let dayIdx=0; dayIdx<DAYS.length; dayIdx++){
        for (let slotIdx=0; slotIdx<slots.length; slotIdx++){
          const arr = weekObj.entries?.[dayIdx]?.[coachIdx]?.[slotIdx];
          if (Array.isArray(arr) && arr.length){ filledCells++; kidCount += arr.length; }
        }
      }
      const emptyCells = totalCellsPerCoach - filledCells;
      const hasLimit = MAX_PER_CELL < 99;
      const maxKids = hasLimit ? (totalCellsPerCoach * MAX_PER_CELL) : null;
      const loadPct = (hasLimit && maxKids) ? Math.round((kidCount / maxKids) * 100) : null;

      const card = document.createElement("div");
      card.className = "sumCard";
      card.innerHTML = `
        <div class="sumName">
          <span>${COACHES[coachIdx]}</span>
          <span class="sumTag">${hasLimit ? (kidCount + "/" + maxKids + " hely • " + loadPct + "%") : (kidCount + " gyerek" )}</span>
        </div>
        <div class="sumMetrics">
          <div class="metric"><div class="k">Gyerekek összesen</div><div class="v">${kidCount}</div><div class="s">${hasLimit ? ("max: "+maxKids) : "max: ∞"}</div></div>
          <div class="metric"><div class="k">Foglalt cellák</div><div class="v">${filledCells}</div><div class="s">max: ${totalCellsPerCoach}</div></div>
          <div class="metric"><div class="k">Üres cellák</div><div class="v">${emptyCells}</div><div class="s">max: ${totalCellsPerCoach}</div></div>
        </div>
      `;
      summaryGrid.appendChild(card);
    }
  }

  function buildThead(slots){
    const thead = document.createElement("thead");
    const tr1 = document.createElement("tr");
    const th0 = document.createElement("th");
    th0.textContent = "Dátum";
    th0.className = "coach";
    th0.style.textAlign = "left";
    th0.style.width = "170px";
    tr1.appendChild(th0);
    for (const coach of COACHES){
      const th = document.createElement("th");
      th.className = "coach";
      th.colSpan = slots.length;
      th.textContent = coach;
      tr1.appendChild(th);
    }
    thead.appendChild(tr1);

    const tr2 = document.createElement("tr");
    const thDay = document.createElement("th");
    thDay.className = "slot";
    thDay.textContent = "";
    tr2.appendChild(thDay);

    for (let c=0; c<COACHES.length; c++){
      for (let s=0; s<slots.length; s++){
        const th = document.createElement("th");
        th.className = "slot";
        th.textContent = slots[s];
        tr2.appendChild(th);
      }
    }
    thead.appendChild(tr2);
    return thead;
  }

  function buildTbody(weekObj, slots, conflicts){
    const tbody = document.createElement("tbody");
    const wk = getWeekKey(state.currentWeekStart);
    const monday = new Date(wk + "T00:00:00");

    for (let dayIdx=0; dayIdx<DAYS.length; dayIdx++){
      const tr = document.createElement("tr");
      const date = new Date(monday); date.setDate(date.getDate() + dayIdx);

      const tdDay = document.createElement("td");
      tdDay.className = "dayCell";
      tdDay.innerHTML = `<div class="dayName">${DAYS[dayIdx].name}</div><div class="dateText">${fmtDate(date)}</div>`;
      tr.appendChild(tdDay);

      for (let coachIdx=0; coachIdx<COACHES.length; coachIdx++){
        for (let slotIdx=0; slotIdx<slots.length; slotIdx++){
          const td = document.createElement("td");
          td.className = "cell";

          const names = getCellNames(weekObj, dayIdx, coachIdx, slotIdx);
          const hasConflict = names.some(n => conflicts?.[dayIdx]?.[slotIdx]?.[normName(n)] === true);
          if (hasConflict) td.classList.add("conflict");

          const q = normName(state.search);
          const matchSearch = q && names.some(n => normName(n).includes(q));
          td.style.boxShadow = matchSearch ? "inset 0 0 0 2px rgba(24,214,161,.35)" : "";

          const chips = document.createElement("div");
          chips.className = "chips";

          for (const n of names){
            const chip = document.createElement("div");
            const warn = conflicts?.[dayIdx]?.[slotIdx]?.[normName(n)] === true;
            chip.className = "chip" + (warn ? " warn" : "");
            chip.textContent = n;

            const x = document.createElement("span");
            x.className = "x";
            x.textContent = "×";
            x.title = "Törlés";
            x.addEventListener("click", (e) => { e.stopPropagation(); removeName(wk, dayIdx, coachIdx, slotIdx, n); });
            chip.appendChild(x);

            chips.appendChild(chip);
          }

          const footer = document.createElement("div");
          footer.className = "cellFooter";
          footer.innerHTML = `<span>${names.length}/${MAX_PER_CELL>=99?"∞":MAX_PER_CELL}</span>`;
          const plus = document.createElement("span");
          plus.className = "plus";
          plus.textContent = "+";
          footer.appendChild(plus);

          td.appendChild(chips);
          td.appendChild(footer);

          td.addEventListener("click", () => openModal({wk, dayIdx, coachIdx, slotIdx, slots}));
          tr.appendChild(td);
        }
      }
      tbody.appendChild(tr);
    }
    return tbody;
  }

  function renderSearch(weekObj, slots){
    const qRaw = (state.search || "").trim();
    const q = normName(qRaw);
    if (!q){ searchResults.classList.remove("show"); searchResults.innerHTML = ""; return; }

    const hits = [];
    for (let dayIdx=0; dayIdx<DAYS.length; dayIdx++){
      for (let slotIdx=0; slotIdx<slots.length; slotIdx++){
        for (let coachIdx=0; coachIdx<COACHES.length; coachIdx++){
          const names = getCellNames(weekObj, dayIdx, coachIdx, slotIdx);
          const matched = names.filter(n => normName(n).includes(q));
          if (matched.length) hits.push({dayIdx, slotIdx, coachIdx, names: matched});
        }
      }
    }

    const wk = getWeekKey(state.currentWeekStart);
    const monday = new Date(wk + "T00:00:00");

    if (!hits.length){
      searchResults.classList.add("show");
      searchResults.innerHTML = `<div class="small">Nincs találat erre a héten: <b style="color:var(--text)">${escapeHtml(qRaw)}</b></div>`;
      return;
    }

    let html = `<div class="small">Találatok (${hits.length}): <b style="color:var(--text)">${escapeHtml(qRaw)}</b></div>`;
    for (const h of hits){
      const date = new Date(monday); date.setDate(date.getDate() + h.dayIdx);
      html += `
        <div class="resItem">
          <span class="tag">${DAYS[h.dayIdx].name} • ${fmtDate(date)} • ${slots[h.slotIdx]}</span>
          <span><b style="color:var(--text)">${COACHES[h.coachIdx]}</b> → ${h.names.map(escapeHtml).join(", ")}</span>
        </div>
      `;
    }
    searchResults.classList.add("show");
    searchResults.innerHTML = html;
  }

  function openModal(sel){
    state.sel = sel;
    const weekObj = ensureWeek(sel.wk);
    const slots = weekObj.slots || DEFAULT_SLOTS;

    const dayDate = new Date(sel.wk + "T00:00:00");
    dayDate.setDate(dayDate.getDate() + sel.dayIdx);

    modalTitle.textContent = `${COACHES[sel.coachIdx]} — ${slots[sel.slotIdx]}`;
    modalMeta.textContent = `${DAYS[sel.dayIdx].name}, ${fmtDate(dayDate)} • Max ${MAX_PER_CELL>=99?"∞":MAX_PER_CELL} gyerek`;

    const names = getCellNames(weekObj, sel.dayIdx, sel.coachIdx, sel.slotIdx);
    renderModalChips(names);
    renderSuggestions(names);

    const conflicts = computeConflicts(weekObj, slots);
    const conflictNames = names.filter(n => conflicts?.[sel.dayIdx]?.[sel.slotIdx]?.[normName(n)] === true);
    conflictHint.textContent = conflictNames.length
      ? `Ütközés: ${conflictNames.join(", ")} ugyanebben az idősávban más edzőnél is szerepel.`
      : "Nincs ütközés ebben a cellában.";

    limitWarn.classList.toggle("show", names.length >= MAX_PER_CELL);
    nameInput.value = "";
    modalBackdrop.classList.add("show");
    modalBackdrop.setAttribute("aria-hidden", "false");
    setTimeout(() => nameInput.focus(), 0);
  }

  function closeModal(){
    modalBackdrop.classList.remove("show");
    modalBackdrop.setAttribute("aria-hidden", "true");
    state.sel = null;
    render();
  }


  // ===== Havi összesítő =====
  function openMonthModal(){
    const d = new Date();
    const ym = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    monthPicker.value = monthPicker.value || ym;
    renderMonthlySummary(monthPicker.value);
    monthBackdrop.classList.add("show");
    monthBackdrop.setAttribute("aria-hidden","false");
  }
  function closeMonthModal(){
    monthBackdrop.classList.remove("show");
    monthBackdrop.setAttribute("aria-hidden","true");
  }

  function renderMonthlySummary(monthValue){
    // monthValue: "YYYY-MM"
    if (!monthValue || !/^\d{4}-\d{2}$/.test(monthValue)){
      monthInfo.textContent = "Válassz egy hónapot.";
      monthTableWrap.innerHTML = "";
      return;
    }
    const [Y, M] = monthValue.split("-").map(Number);
    const monthIdx = M - 1;
    const first = new Date(Date.UTC(Y, monthIdx, 1));
    const next = new Date(Date.UTC(Y, monthIdx+1, 1));

    // stats init
    const stats = COACHES.map(() => ({
      days: new Set(),
      hours: 0,
      kidSessions: 0,
      uniqueKids: new Set(),
      filledCells: 0
    }));

    const weeks = state.db.weeks || {};
    for (const wk of Object.keys(weeks)){
      const w = weeks[wk];
      const wkDate = new Date(wk + "T00:00:00Z");
      if (isNaN(wkDate.getTime())) continue;

      const slots = Array.isArray(w?.slots) ? w.slots : DEFAULT_SLOTS;
      const entries = w?.entries;
      for (let day=0; day<DAYS.length; day++){
        const dayDate = new Date(wkDate.getTime());
        dayDate.setUTCDate(dayDate.getUTCDate() + day);
        if (dayDate < first || dayDate >= next) continue;

        const dayKey = dayDate.toISOString().slice(0,10);
        for (let c=0; c<COACHES.length; c++){
          let hasAny = false;
          for (let s=0; s<slots.length; s++){
            const names = entries?.[day]?.[c]?.[s];
            if (Array.isArray(names) && names.length){
              hasAny = true;
              stats[c].filledCells += 1;
              stats[c].hours += SLOT_DURATION_HOURS;
              stats[c].kidSessions += names.length;
              for (const nm of names) stats[c].uniqueKids.add(prettifyName(nm));
            }
          }
          if (hasAny) stats[c].days.add(dayKey);
        }
      }
    }

    const totalHours = stats.reduce((a,x)=>a+x.hours,0);
    const totalKidSessions = stats.reduce((a,x)=>a+x.kidSessions,0);
    const totalDays = stats.reduce((a,x)=>a+x.days.size,0);
    monthInfo.textContent = `Összesen: ${totalDays} edző-nap • ${totalHours} óra • ${totalKidSessions} gyerek alkalom`;

    const rows = stats.map((st, i) => {
      return `
        <tr>
          <td style="white-space:nowrap"><b>${escapeHtml(COACHES[i])}</b></td>
          <td style="text-align:right">${st.days.size}</td>
          <td style="text-align:right">${st.hours}</td>
          <td style="text-align:right">${st.filledCells}</td>
          <td style="text-align:right">${st.kidSessions}</td>
          <td style="text-align:right">${st.uniqueKids.size}</td>
        </tr>
      `;
    }).join("");

    monthTableWrap.innerHTML = `
      <table class="mini" style="width:100%; border-collapse:separate; border-spacing:0 8px">
        <thead>
          <tr class="muted" style="font-size:12px">
            <th style="text-align:left; padding:6px 10px">Edző</th>
            <th style="text-align:right; padding:6px 10px">Nap</th>
            <th style="text-align:right; padding:6px 10px">Óra</th>
            <th style="text-align:right; padding:6px 10px">Foglalt cella</th>
            <th style="text-align:right; padding:6px 10px">Gyerek alkalom</th>
            <th style="text-align:right; padding:6px 10px">Egyedi gyerek</th>
          </tr>
        </thead>
        <tbody>
          ${rows || ""}
        </tbody>
      </table>
    `;
  }


  function renderModalChips(names){
    modalChips.innerHTML = "";
    if (!names.length){ modalChips.innerHTML = `<span class="small">— üres —</span>`; return; }
    for (const n of names){
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = n;
      const x = document.createElement("span");
      x.className = "x";
      x.textContent = "×";
      x.title = "Törlés";
      x.addEventListener("click", () => {
        if (!state.sel) return;
        removeName(state.sel.wk, state.sel.dayIdx, state.sel.coachIdx, state.sel.slotIdx, n);
        openModal(state.sel);
      });
      chip.appendChild(x);
      modalChips.appendChild(chip);
    }
  }

  function renderSuggestions(currentNames){
    const bank = (state.db.nameBank || []).slice().reverse();
    const existing = new Set(currentNames.map(normName));
    const q = normName(nameInput.value || "");
    const filtered = bank
      .filter(n => !existing.has(normName(n)))
      .filter(n => !q || normName(n).includes(q))
      .slice(0, 18);

    suggestions.innerHTML = "";
    if (!filtered.length){ suggestions.innerHTML = `<span class="small">— nincs javaslat —</span>`; return; }

    for (const n of filtered){
      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "pill";
      pill.textContent = n;
      pill.addEventListener("click", () => { nameInput.value = n; addNameFromInput(); });
      suggestions.appendChild(pill);
    }
  }

  nameInput.addEventListener("input", () => {
    if (!state.sel) return;
    const wk = state.sel.wk;
    const weekObj = ensureWeek(wk);
    const names = getCellNames(weekObj, state.sel.dayIdx, state.sel.coachIdx, state.sel.slotIdx);
    renderSuggestions(names);
  });

  function addNameFromInput(){
    if (!state.sel) return;
    const raw = (nameInput.value || "").trim();
    if (!raw) return;

    const wk = state.sel.wk;
    const weekObj = ensureWeek(wk);
    const names = getCellNames(weekObj, state.sel.dayIdx, state.sel.coachIdx, state.sel.slotIdx);

    if (names.length >= MAX_PER_CELL){ limitWarn.cla
